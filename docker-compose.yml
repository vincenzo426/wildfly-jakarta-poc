# =============================================================================
# Docker Compose - WildFly Cluster con Load Balancer
# =============================================================================
# 
# Uso:
#   docker-compose up -d                    # Avvia 1 istanza WildFly + Nginx
#   docker-compose up -d --scale wildfly=5  # Avvia 5 istanze WildFly + Nginx
#   docker-compose up -d --scale wildfly=10 # Avvia 10 istanze WildFly + Nginx
#
# =============================================================================

version: '3.8'

services:
  # ===========================================================================
  # NGINX - Load Balancer
  # ===========================================================================
  nginx:
    image: nginx:alpine
    container_name: wildfly-loadbalancer
    ports:
      - "80:80"           # HTTP principale
      - "8081:80"         # Alias per comodit√†
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
    depends_on:
      - wildfly
    networks:
      - wildfly-cluster
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost/health"]
      interval: 10s
      timeout: 5s
      retries: 3

  # ===========================================================================
  # WILDFLY - Application Server (scalabile)
  # ===========================================================================
  wildfly:
    build:
      context: .
      dockerfile: Dockerfile
    # Non esporre porte direttamente - passa tutto da Nginx
    expose:
      - "8080"
    environment:
      - TZ=Europe/Rome
      # Modificato -Xmx da 256m a 384m per eguagliare le JAVA_OPTS di Quarkus
      - JAVA_OPTS=-Xms128m -Xmx384m -XX:MetaspaceSize=64m -XX:MaxMetaspaceSize=128m
    networks:
      - wildfly-cluster
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/wildfly-jakarta-poc/health/ready"]
      interval: 10s
      timeout: 5s
      start_period: 60s
      retries: 3
    # Risorse limitate per simulare ambiente reale
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 512M
        reservations:
          cpus: '0.1'       
          memory: 128M

networks:
  wildfly-cluster:
    driver: bridge
